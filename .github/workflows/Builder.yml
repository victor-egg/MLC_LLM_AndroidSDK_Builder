name: Builder

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: '发布标签'
        required: true
        default: 'unknown-model'
      release_name:
        description: '发布名称'
        required: false
        default: 'Release'
      model:
        description: 'huggingface模型地址'
        required: true
        default: ''
      model_id:
        description: '模型id'
        required: true
        default: ''
      estimated_vram_bytes:
        description: '运行模型所需的vRAM'
        required: false
        default: '3000000000'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: 更新 pip
        run: python -m pip install --upgrade pip

      - name: 安装 MLC-LLM 环境(Python)
        run: |
          sudo apt update
          sudo apt install git-lfs git
          python -m pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu
          python -c "import mlc_llm; print(mlc_llm)"

      - name: 安装 JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'jetbrains'
          java-version: '21'
          java-package: 'jdk'

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable

      - name: 安装 Android NDK
        run: |
          echo "y" | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager "ndk;27.3.13750724"
          echo "ANDROID_NDK=${ANDROID_HOME}/ndk/27.3.13750724" >> $GITHUB_ENV
          echo "TVM_NDK_CC=${ANDROID_NDK}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android31-clang" >> $GITHUB_ENV

      - name: 拉取 MLC-LLM 源码
        run: |
          git clone https://github.com/mlc-ai/mlc-llm.git
          cd mlc-llm
          git submodule update --init --recursive
          echo "MLC_LLM_SOURCE_DIR=${PWD}" >> $GITHUB_ENV
          echo "TVM_SOURCE_DIR=${PWD}/3rdparty/tvm" >> $GITHUB_ENV
          cd ..

      - name: 下载模型
        run: |
          pip install -U "huggingface_hub[cli]"
          echo "模型: ${{ github.event.inputs.model }}"
          hf download ${{ github.event.inputs.model }} --local-dir "model"

      - name: 环境信息
        run: |
          echo "========== 环境信息 =========="
          echo "Python 版本: $(python --version)"
          echo "Java 版本: $(java -version 2>&1 | head -n 1)"
          echo "JAVA_HOME: $JAVA_HOME"
          ls -la $JAVA_HOME
          echo "Rust 版本: $(rustc --version)"
          echo "Cargo 版本: $(cargo --version)"
          echo "Android NDK: $ANDROID_NDK"
          ls -la $ANDROID_NDK
          echo "TVM_NDK_CC: $TVM_NDK_CC"
          ls -la $TVM_NDK_CC
          echo "MLC_LLM_SOURCE_DIR: $MLC_LLM_SOURCE_DIR"
          ls -la $MLC_LLM_SOURCE_DIR
          echo "TVM_SOURCE_DIR: $TVM_SOURCE_DIR"
          ls -la $TVM_SOURCE_DIR
          echo "OS: $(uname -a)"
          echo "=============================="
          echo "工作目录"
          ls -al

      - name: 创建编译配置
        run: |
          jq -n \
            --arg model_id "${{ github.event.inputs.model_id }}" \
            --arg vram "${{ github.event.inputs.estimated_vram_bytes }}" \
            '{
              "device": "android",
              "model_list": [
                {
                  "model": "./model",
                  "model_id": $model_id,
                  "estimated_vram_bytes": ($vram | tonumber), 
                  "bundle_weight": true
                }
              ]
            }' > mlc-package-config.json

      - name: 验证配置
        run: cat mlc-package-config.json

      - name: 构建 Android SDK
        run: |
          python -m mlc_llm package
          ls -al
      
      - name: 上传构建文件
        uses: actions/upload-artifact@v4
        with:
          name: Android SDK
          path: dist/
          retention-days: 7

      - name: 发布文件
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_name }}
          draft: false
          prerelease: false
          files: |
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
